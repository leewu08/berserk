<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ user.username }}ë‹˜ì˜ í”„ë¡œí•„</title>
  <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-canvas {
      width: 100%;
      max-width: 700px;
      height: 350px;
      margin: auto;
    }
    .analysed { color: green; font-weight: bold; }
    .not-analysed { color: red; font-weight: bold; }
    .white-player { background-color: #ffffff; }
    .black-player { background-color: #f1f1f1; }
    .result-win { background-color: #d4edda; color: #155724; font-weight: bold; }
    .result-lose { background-color: #f8d7da; color: #721c24; font-weight: bold; }
    .result-draw { background-color: #f0f0f0; color: #555; }
  </style>
</head>
<body>
<div class="page">
  <div class="container-xl">
    <h2 class="page-title mt-4">{{ user.username }}ë‹˜ì˜ í”„ë¡œí•„</h2>

    <div class="card my-4">
      <div class="card-body">
        <p><strong>ê°€ì…ì¼:</strong> {{ user.createdAt | timestamp_to_date }}</p>
        <p><strong>ìµœê·¼ ì ‘ì†:</strong> {{ user.seenAt | timestamp_to_date }}</p>
        <p><strong>í”„ë¡œí•„ ë§í¬:</strong> <a href="{{ user.url }}" target="_blank">{{ user.url }}</a></p>
      </div>
    </div>

    <div class="card my-4">
      <div class="card-header"><h3 class="card-title">ì „ì </h3></div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr>
            <th>ì „ì²´ ê²Œì„ ìˆ˜</th><th>ë­í¬ ê²Œì„</th><th>ìŠ¹ë¦¬</th><th>íŒ¨ë°°</th><th>ë¬´ìŠ¹ë¶€</th>
          </tr></thead>
          <tbody>
            <tr>
              <td>{{ user.count.all }}</td>
              <td>{{ user.count.rated }}</td>
              <td>{{ user.count.win }}</td>
              <td>{{ user.count.loss }}</td>
              <td>{{ user.count.draw }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="card-body">
        {% set effective_games = user.count.all - user.count.draw %}
        {% if effective_games > 0 %}
          {% set win_rate = (user.count.win / effective_games) * 100 %}
        {% else %}
          {% set win_rate = 0 %}
        {% endif %}
        <p><strong>ìŠ¹ë¥ :</strong> {{ win_rate | round(2) }}%</p>
      </div>
    </div>

    <div class="card my-4">
      <div class="card-header"><h3 class="card-title">ê²Œì„ë³„ ë ˆì´íŒ…</h3></div>
      <div class="table-responsive">
        <table class="table">
          <thead><tr>
            <th>ê²Œì„ ì¢…ë¥˜</th><th>ê²Œì„ ìˆ˜</th><th>ë ˆì´íŒ…</th><th>RD</th><th>ë³€í™”ëŸ‰</th>
          </tr></thead>
          <tbody>
            {% for mode, data in sorted_perfs %}
              <tr>
                <td>{{ mode }}</td>
                <td>{{ data.games }}</td>
                <td>{{ data.rating }}</td>
                <td>{% if data.rd != 500 %}{{ data.rd }}{% endif %}</td>
                <td>{{ data.prog }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card my-4">
      <div class="card-header"><h3 class="card-title">ğŸ“˜ ê°€ì¥ ë§ì´ ì‚¬ìš©í•œ ì˜¤í”„ë‹</h3></div>
      <div class="card-body">
        <ul>
          {% for opening, count in most_common_openings %}
            <li>{{ opening }} - {{ count }}íšŒ</li>
          {% endfor %}
        </ul>
        <canvas id="openingChart" class="chart-canvas"></canvas>
      </div>
    </div>

    <div class="card my-4">
      <div class="card-header"><h3 class="card-title">ìµœê·¼ ê²Œì„ (ìµœëŒ€ {{ max_games }}ê°œ)</h3></div>
      <div class="card-body">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <label class="form-label">ê¸°ê°„ í•„í„°</label>
            <select class="form-select" id="timeFilterSelect">
              <option value="all">ì „ì²´</option>
              <option value="7">ìµœê·¼ 1ì£¼</option>
              <option value="30">ìµœê·¼ 1ê°œì›”</option>
              <option value="90">ìµœê·¼ 3ê°œì›”</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ê²Œì„ ìˆ˜</label>
            <select class="form-select" id="maxGamesSelect">
              <option value="10">10ê°œ</option>
              <option value="20">20ê°œ</option>
              <option value="50" selected>50ê°œ</option>
              <option value="100">100ê°œ</option>
              <option value="200">200ê°œ</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ì¢…ë£Œ ë°©ì‹</label>
            <select class="form-select" id="endTypeSelect">
              <option value="all">ì „ì²´</option>
              <option value="mate">ì²´í¬ë©”ì´íŠ¸</option>
              <option value="resign">ê¸°ê¶Œ</option>
              <option value="timeout">ì‹œê°„ì´ˆê³¼</option>
              <option value="draw">ë¬´ìŠ¹ë¶€</option>
              <option value="outoftime">ì‹œê°„ì´ˆê³¼ (ì˜¤í”„ë¼ì¸)</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table" id="gamesTable">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th><th>ìƒ‰ìƒ</th><th>ìƒëŒ€</th><th>ë‚´ ë ˆì´íŒ…</th><th>ìƒëŒ€ ë ˆì´íŒ…</th>
                <th>ê²°ê³¼</th><th>ì˜¤í”„ë‹</th><th>ìˆ˜ ìˆœ</th><th>ì¢…ë£Œ ë°©ì‹</th><th>ë¶„ì„</th><th>ë§í¬</th>
              </tr>
            </thead>
            <tbody id="gamesBody">
              <!-- JavaScriptë¡œ ì‚½ì… -->
            </tbody>
          </table>
        </div>

        <div class="mt-3">
          <button class="btn btn-primary" id="loadMoreBtn">ë” ë³´ê¸°</button>
          <button class="btn btn-secondary" id="collapseBtn" style="display:none;">ì ‘ê¸°</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const username = "{{ user.username }}";
  const endTypeSelect = document.getElementById('endTypeSelect');
  const timeFilterSelect = document.getElementById('timeFilterSelect');
  const maxGamesSelect = document.getElementById('maxGamesSelect');
  const gamesBody = document.getElementById('gamesBody');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const collapseBtn = document.getElementById('collapseBtn');
  const ctx = document.getElementById('openingChart').getContext('2d');

  const INITIAL_SHOW_COUNT = 10;
  let maxRowsToShow = INITIAL_SHOW_COUNT;
  let allGames = [];
  let openingChartInstance = null;

  function timestampToDate(ts) {
    return new Date(ts).toLocaleString();
  }

  function renderGames() {
    gamesBody.innerHTML = '';
    const gamesToShow = allGames.slice(0, maxRowsToShow);

    if (gamesToShow.length === 0) {
      gamesBody.innerHTML = '<tr><td colspan="11">ì¡°ê±´ì— ë§ëŠ” ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      loadMoreBtn.style.display = 'none';
      collapseBtn.style.display = 'none';
      return;
    }

    for (const game of gamesToShow) {
      const isWhite = (game.players.white.user.name.toLowerCase() === username.toLowerCase());
      const opponent = isWhite ? game.players.black.user.name : game.players.white.user.name;
      const myRating = isWhite ? game.players.white.rating : game.players.black.rating;
      const oppRating = isWhite ? game.players.black.rating : game.players.white.rating;

      const winner = game.winner;
      let resultText = "ë¬´ìŠ¹ë¶€", resultClass = "result-draw";
      if (winner) {
        if ((winner === "white" && isWhite) || (winner === "black" && !isWhite)) {
          resultText = "ìŠ¹ë¦¬"; resultClass = "result-win";
        } else {
          resultText = "íŒ¨ë°°"; resultClass = "result-lose";
        }
      }

      const openingName = game.opening?.name || "ì•Œ ìˆ˜ ì—†ìŒ";
      const movesPreview = game.moves?.substring(0, 50) + (game.moves?.length > 50 ? "..." : "") || "";
      const status = game.status || "";
      const analysedText = game.is_analysed ? "ë¶„ì„ë¨" : "ë¯¸ë¶„ì„";
      const analysedClass = game.is_analysed ? "analysed" : "not-analysed";
      const createdAt = timestampToDate(game.createdAt);
      const colorClass = isWhite ? "white-player" : "black-player";

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${createdAt}</td>
        <td class="${colorClass}">${isWhite ? "í°ìƒ‰" : "ê²€ì€ìƒ‰"}</td>
        <td>${opponent}</td>
        <td>${myRating}</td>
        <td>${oppRating}</td>
        <td class="${resultClass}">${resultText}</td>
        <td>${openingName}</td>
        <td title="${game.moves}">${movesPreview}</td>
        <td>${status}</td>
        <td class="${analysedClass}">${analysedText}</td>
        <td><a href="https://lichess.org/${game.id}" target="_blank">ë³´ê¸°</a></td>
      `;
      gamesBody.appendChild(row);
    }

    loadMoreBtn.style.display = (maxRowsToShow < allGames.length) ? 'inline-block' : 'none';
    collapseBtn.style.display = (maxRowsToShow > INITIAL_SHOW_COUNT) ? 'inline-block' : 'none';
  }

  function drawOpeningChart(games) {
    const openingCountMap = {};
    games.forEach(game => {
      const fullName = game.opening?.name || "ì•Œ ìˆ˜ ì—†ìŒ";
      const openingName = fullName.includes(':') ? fullName.split(':')[0].trim() : fullName;
      openingCountMap[openingName] = (openingCountMap[openingName] || 0) + 1;
    });

    const sortedOpenings = Object.entries(openingCountMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = sortedOpenings.map(e => e[0]);
    const data = sortedOpenings.map(e => e[1]);

    if (openingChartInstance) openingChartInstance.destroy();
    openingChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'ì˜¤í”„ë‹ ì‚¬ìš© íšŸìˆ˜', data: data, backgroundColor: 'rgba(0, 123, 255, 0.7)' }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  async function fetchGames() {
    let url = `/api/games/${username}?max_games=${maxGamesSelect.value}`;
    if (endTypeSelect.value !== 'all') url += `&endType=${encodeURIComponent(endTypeSelect.value)}`;
    if (timeFilterSelect.value !== 'all') url += `&days=${encodeURIComponent(timeFilterSelect.value)}`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      allGames = await res.json();
      maxRowsToShow = INITIAL_SHOW_COUNT;
      renderGames();
      drawOpeningChart(allGames);
    } catch (err) {
      gamesBody.innerHTML = `<tr><td colspan="11" style="color:red;">${err.message}</td></tr>`;
      if (openingChartInstance) openingChartInstance.destroy();
      loadMoreBtn.style.display = 'none';
      collapseBtn.style.display = 'none';
    }
  }

  loadMoreBtn.addEventListener('click', () => {
    maxRowsToShow = Math.min(maxRowsToShow + 10, allGames.length);
    renderGames();
  });
  collapseBtn.addEventListener('click', () => {
    maxRowsToShow = INITIAL_SHOW_COUNT;
    renderGames();
  });

  [endTypeSelect, timeFilterSelect, maxGamesSelect].forEach(el => el.addEventListener('change', fetchGames));
  fetchGames();
});
</script>
</body>
</html>
